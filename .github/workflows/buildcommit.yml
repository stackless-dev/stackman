name: build test and commit

on:
  push:
    branches: [ master, dev ]
    tags:
      - 'v*.*.*'

  pull_request:
    branches: [ master ]

jobs:

  build-linux-gnu:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        name: [AMD64, i386, arm, aarch64]
        include:
          - name: i386
            platformflags: -m32
          - name: arm
            platformtools:  arm-linux-gnueabi
            emulator: qemu-arm
          - name: aarch64
            platformtools:  aarch64-linux-gnu
            emulator: qemu-aarch64
    # name: build-linux-gnu (${{matrix.name}})
    env:
      PLATFORMFLAGS: ${{matrix.platformflags}}
      PLATFORM_PREFIX: ${{matrix.platformtools}}
      EMULATOR: ${{matrix.emulator}}
    steps:
    - uses: actions/checkout@v4
    - name: install multilib
      run: sudo apt-get install --no-install-recommends -y gcc-multilib g++-multilib 
      if: ${{ matrix.name == 'i386' }}
    - name: install qemu
      if: matrix.emulator
      run: sudo apt-get install --no-install-recommends -y qemu-user 
    - name: install abi lib
      if: matrix.platformtools
      run: sudo apt-get install --no-install-recommends -y gcc-${{matrix.platformtools}} g++-${{matrix.platformtools}} 
    - name: make
      run: make all
    - name: test
      run: make test
    - name: set abi name
      run: echo abiname=$(make abiname) >> $GITHUB_ENV
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.abiname }}
        path: lib/${{ env.abiname }}/libstackman.a
      
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x86, x64, arm64]
        include:
          - platform: x86
            folder: Win32
            native: yes
          - platform: x64
            folder: x64
            native: yes
          - platform: arm64
            folder: arm64
          
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: build
        run: msbuild.exe vs2022\stackman.sln /p:Platform=${{matrix.platform}}
      - name: strip timestamps from lib
        run: python tools/strip-lib.py lib/win_${{matrix.platform}}/stackman.lib
      - name: rebuild after stripping
        run: msbuild.exe vs2022\stackman.sln /p:Platform=${{matrix.platform}}
      - name: test
        if: ${{ matrix.native == 'yes' }}
        run: vs2022\${{matrix.folder}}\Debug\test.exe
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win_${{ matrix.platform }}
          path: lib/win_${{matrix.platform}}/stackman.lib
  
  commit-artifacts:
    runs-on: ubuntu-latest
    needs: [build-linux-gnu, build-windows]
    if: ${{ github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/download-artifact@v4
      with:
        path: lib
        
    - name: Commit changes
      run: |
        git config --global user.name 'Automation tool'
        git config --global user.email 'automation-tool@users.noreply.github.com'
        git add lib/*.a lib/*.lib
        git status
        git diff-index --quiet HEAD || git commit -m "Automated build"
        git push

  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux-gnu, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create release archive
      run: |
        mkdir -p release
        # Copy libraries maintaining directory structure
        mkdir -p release/lib/sysv_amd64 release/lib/sysv_i386 release/lib/arm32 release/lib/aarch64
        mkdir -p release/lib/win_x86 release/lib/win_x64 release/lib/win_arm64
        
        cp artifacts/sysv_amd64/libstackman.a release/lib/sysv_amd64/
        cp artifacts/sysv_i386/libstackman.a release/lib/sysv_i386/
        cp artifacts/arm32/libstackman.a release/lib/arm32/
        cp artifacts/aarch64/libstackman.a release/lib/aarch64/
        cp artifacts/win_x86/stackman.lib release/lib/win_x86/
        cp artifacts/win_x64/stackman.lib release/lib/win_x64/
        cp artifacts/win_arm64/stackman.lib release/lib/win_arm64/
        
        # Copy headers and documentation
        cp -r stackman release/
        cp README.md LICENSE CHANGELOG.md release/
        
        # Create version-specific archive
        VERSION=${GITHUB_REF#refs/tags/v}
        cd release
        tar -czf ../stackman-${VERSION}-all-platforms.tar.gz .
        cd ..
        
        # Create individual platform archives for easy download
        mkdir -p platform-archives
        tar -czf platform-archives/stackman-${VERSION}-sysv_amd64.tar.gz -C release stackman lib/sysv_amd64 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-sysv_i386.tar.gz -C release stackman lib/sysv_i386 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-arm32.tar.gz -C release stackman lib/arm32 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-aarch64.tar.gz -C release stackman lib/aarch64 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-win_x86.tar.gz -C release stackman lib/win_x86 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-win_x64.tar.gz -C release stackman lib/win_x64 README.md LICENSE CHANGELOG.md
        tar -czf platform-archives/stackman-${VERSION}-win_arm64.tar.gz -C release stackman lib/win_arm64 README.md LICENSE CHANGELOG.md
        
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          stackman-${{ steps.get_version.outputs.VERSION }}-all-platforms.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-sysv_amd64.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-sysv_i386.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-arm32.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-aarch64.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-win_x86.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-win_x64.tar.gz
          platform-archives/stackman-${{ steps.get_version.outputs.VERSION }}-win_arm64.tar.gz
        body: |
          See [CHANGELOG.md](https://github.com/stackless-dev/stackman/blob/${{ github.ref_name }}/CHANGELOG.md) for details.
          
          ## Downloads
          
          **Option 1: All Platforms**
          - Download `stackman-${{ steps.get_version.outputs.VERSION }}-all-platforms.tar.gz` for all platforms
          
          **Option 2: Single Platform**
          Download the platform-specific archive for your system:
          - `stackman-${{ steps.get_version.outputs.VERSION }}-sysv_amd64.tar.gz` - Linux x86_64
          - `stackman-${{ steps.get_version.outputs.VERSION }}-sysv_i386.tar.gz` - Linux x86 (32-bit)
          - `stackman-${{ steps.get_version.outputs.VERSION }}-arm32.tar.gz` - Linux ARM (32-bit, AAPCS)
          - `stackman-${{ steps.get_version.outputs.VERSION }}-aarch64.tar.gz` - Linux ARM64 (AAPCS64)
          - `stackman-${{ steps.get_version.outputs.VERSION }}-win_x86.tar.gz` - Windows x86 (32-bit)
          - `stackman-${{ steps.get_version.outputs.VERSION }}-win_x64.tar.gz` - Windows x64
          - `stackman-${{ steps.get_version.outputs.VERSION }}-win_arm64.tar.gz` - Windows ARM64
          
          Each archive contains:
          - Headers (`stackman/`)
          - Library file (`lib/{platform}/libstackman.a` or `lib/{platform}/stackman.lib`)
          - Documentation (README.md, LICENSE, CHANGELOG.md)
          
          ## Usage
          
          ```bash
          # Extract
          tar -xzf stackman-${{ steps.get_version.outputs.VERSION }}-sysv_amd64.tar.gz
          
          # Compile your code
          gcc -Istackman mycode.c -Llib/sysv_amd64 -lstackman
          ```
