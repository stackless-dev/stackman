name: RISC-V Test Build

on:
  push:
    branches: [ riscv-support ]
  pull_request:
    branches: [ master ]
    paths:
      - 'stackman/platforms/switch_riscv64_gcc.*'
      - 'stackman/platforms/platform.h'
      - '.github/workflows/riscv-test.yml'

jobs:

  build-riscv64:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install RISC-V toolchain and QEMU
      run: |
        sudo apt-get update
        sudo apt-get install --no-install-recommends -y \
          gcc-riscv64-linux-gnu \
          g++-riscv64-linux-gnu \
          qemu-user
    
    - name: Show toolchain info
      run: |
        riscv64-linux-gnu-gcc --version
        qemu-riscv64 --version
    
    - name: Build library
      env:
        PLATFORM_PREFIX: riscv64-linux-gnu-
      run: make all
    
    - name: Show ABI name
      run: make abiname
    
    - name: Run tests
      env:
        PLATFORM_PREFIX: riscv64-linux-gnu-
        EMULATOR: qemu-riscv64
      run: make test
    
    - name: Upload library artifact
      uses: actions/upload-artifact@v4
      with:
        name: riscv64-test-build
        path: lib/riscv64/libstackman.a
